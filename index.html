<!Doctype html>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height"/>
        <title>React</title>
        <!-- Latest compiled and minified CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body>
        <div class="container-fluid border">
            <label
                for="exampleFormControlInput1"
                class="form-label"
            >
                Prompt 優化
            </label>
            <div class="row border">
                <div class="col-sm border text-center">
                    <div class="row border">
                        <!-- 可修改 rows 增加輸入框高度 -->
                        <textarea
                            class="form-control"
                            id="exampleFormControlTextarea1"
                            rows="5" 
                            placeholder="系統預設輸入 prompt"
                        ></textarea>
                    </div>
                    <div class="row border">
                        <!-- 可修改 rows 增加輸入框高度 -->
                        <textarea
                            class="form-control"
                            id="exampleFormControlTextarea2"
                            rows="5" 
                            placeholder="使用者輸入 prompt"
                        ></textarea>
                    </div>
                </div>
                <div class="col-sm-1 border text-center d-flex flex-column justify-content-center">
                    <button
                        id="promptButton"
                        type="button"
                        class="btn align-items-center btn-outline-primary"
                    >
                        優化》
                    </button>
                    <button
                        id="resetButton"
                        type="button"
                        class="btn align-items-center btn-outline-primary"
                    >
                        《重置
                    </button>
                </div>
                <div class="col-sm border text-center">
                    <!-- 可修改 rows 增加輸入框高度 -->
                    <textarea
                        class="form-control"
                        id="exampleFormControlTextarea3"
                        rows="10"
                        disabled="true"
                    ></textarea>                    
                </div>
            </div>
        </div>

        <!-- Latest compiled JavaScript -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // DOM
            const textAreaSystem = document.getElementById("exampleFormControlTextarea1");
            const textAreaUser = document.getElementById("exampleFormControlTextarea2");
            const textAreaOutput = document.getElementById("exampleFormControlTextarea3");
            const resetButton = document.getElementById("resetButton");
            const promptButton = document.getElementById("promptButton");
            // constant
            const sysText = "你熟悉prompts architecture的產生，我會給你一段描述，你幫我生成一段可以用來生成有正面人像照片寫實風格的prompt，結果請用英文回應。如果描述沒有人像，生成一段亞洲漂亮女生的prompt";
            const userText = "狗狗";
            const PromptOpUrl = "https://asia-east1-mymoji-dev.cloudfunctions.net/mymoji-prompt-optimize";
            // variable
            let loading = false;

            const init = () => {
                console.log("init");
                textAreaSystem.value = sysText;
                textAreaUser.value = userText;
            };

            const setPromptButtonText = () => {
                if(loading) {
                    promptButton.textContent = "waiting...";
                    promptButton.disabled = true;
                } else {
                    promptButton.textContent = "優化》";
                    promptButton.disabled = false;
                }
            };


            resetButton.addEventListener("click", () => {
                console.log("clicked");
                init();
            });

            promptButton.addEventListener("click", () => {
                loading = true;
                setPromptButtonText();

                const raw = JSON.stringify({
                    "system_content": textAreaSystem.value,
                    "user_content": textAreaUser.value
                });

                const requestOptions = {
                    method: "POST",
                    body: raw,
                    headers: {
                        "user-agent": "Mozilla/4.0 MDN Example",
                        "content-type": "application/json",
                    }
                };

                fetch(PromptOpUrl, requestOptions).then((response) => response.json())
                                                  .then((result) => {
                                                    console.log(result.generated_prompt);
                                                    textAreaOutput.value = result.generated_prompt;
                                                  })
                                                  .catch((error) => {
                                                    console.error(error);
                                                    textAreaOutput.value = error;
                                                  })
                                                  .finally(() => {
                                                    loading = false;
                                                    setPromptButtonText();
                                                  });

            })

            init();
            
        </script>
        <!-- script type="module" 需以 localhost 開啟才不會發生 CORS 異常-->

    </body>
</html>
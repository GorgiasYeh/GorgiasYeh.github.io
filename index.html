<!Doctype html>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height"/>
        <title>Ubitus POC</title>
        <!-- Latest compiled and minified CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body>
        <div class="container-fluid border">

            <div class="row border">
                <label
                    for="exampleFormControlInput1"
                    class="form-label"
                >
                    <h3 class="text-primary">Prompt 優化</h3>
                </label>
                <div class="col-sm border text-center">
                    <div class="row border">
                        <label for="exampleFormControlInput1" class="form-label">系統預設</label>
                        <!-- 可修改 rows 增加輸入框高度 -->
                        <textarea
                            class="form-control"
                            id="exampleFormControlTextarea1"
                            rows="5" 
                            placeholder="系統預設輸入 prompt"
                        ></textarea>
                    </div>
                    <div class="row border">
                        <label for="exampleFormControlInput1" class="form-label">使用者輸入</label>
                        <!-- 可修改 rows 增加輸入框高度 -->
                        <textarea
                            class="form-control"
                            id="exampleFormControlTextarea2"
                            rows="5" 
                            placeholder="使用者輸入 prompt"
                        ></textarea>
                    </div>
                </div>
                <div class="col-sm-1 border text-center d-flex flex-column justify-content-center">
                    <button
                        id="promptButton"
                        type="button"
                        class="btn align-items-center btn-outline-primary"
                    >
                        優化》
                    </button>
                    <button
                        id="resetButton"
                        type="button"
                        class="btn align-items-center btn-outline-primary"
                    >
                        《重置
                    </button>
                </div>
                <div class="col-sm border text-center">
                    <label for="exampleFormControlInput1" class="form-label">優化的 Prompt</label>
                    <!-- 可修改 rows 增加輸入框高度 -->
                    <textarea
                        class="form-control"
                        id="exampleFormControlTextarea3"
                        rows="10"
                        disabled="true"
                    ></textarea>                    
                </div>
            </div>

            <div class="row border">
                <label
                    for="exampleFormControlInput1"
                    class="form-label"
                >
                    <h3 class="text-primary">文字產生圖片</h3>
                </label>
                <div class="col-sm border text-center">
                    <div class="row border">
                        <label for="exampleFormControlInput1" class="form-label">Prompts</label>
                        <!-- 可修改 rows 增加輸入框高度 -->
                        <textarea
                            class="form-control"
                            id="exampleFormControlTextarea4"
                            rows="5" 
                            placeholder="請輸入 prompts"
                        ></textarea>
                    </div>
                    <div class="row border">
                        <label for="exampleFormControlInput1" class="form-label">Negative Prompts</label>
                        <!-- 可修改 rows 增加輸入框高度 -->
                        <textarea
                            class="form-control"
                            id="exampleFormControlTextarea5"
                            rows="5" 
                            placeholder="使用者輸入 prompt"
                        ></textarea>
                    </div>
                </div>
                <div class="col-sm-1 border text-center d-flex flex-column justify-content-center">
                    <button
                        id="imageButton"
                        type="button"
                        class="btn align-items-center btn-outline-primary"
                    >
                        產圖片
                    </button>
                    <button
                        id="resetButton2"
                        type="button"
                        class="btn align-items-center btn-outline-primary"
                    >
                        《重置
                    </button>                    
                </div>
                <div class="col-sm border text-center">
                    <div class="border text-center d-flex flex-column justify-content-center align-items-center">
                        <label for="exampleFormControlInput1" class="form-label">產生的圖片</label>
                        <div style="width: 512px; height: 512px" class="border">
                            <img
                                id="producedIm2g"
                                src="https://t3.ftcdn.net/jpg/04/60/01/36/360_F_460013622_6xF8uN6ubMvLx0tAJECBHfKPoNOR5cRa.jpg"
                                style="width: 100%; height: 100%;"
                                alt="Cinque Terre"
                            />
                        </div>
                    </div>
                </div>
            </div>

            <div class="row border">
                <label
                    for="exampleFormControlInput1"
                    class="form-label"
                >
                    <h3 class="text-primary">換臉</h3>
                </label>
                <div class="col-sm border text-center">
                    <div class="row border justify-content-center">
                        <label for="exampleFormControlInput1" class="form-label">來源圖片</label>
                        <div><input id="sourceImgUploader" type="file" accept="image/*"/></div>
                        <div style="width: 256px; height: 256px" class="border">
                            <img
                                id="sourceImg"
                                src="https://t3.ftcdn.net/jpg/04/60/01/36/360_F_460013622_6xF8uN6ubMvLx0tAJECBHfKPoNOR5cRa.jpg"
                                style="width: 100%; height: 100%;"
                                alt="Cinque Terre"
                            />
                        </div>
                    </div>
                    <div class="row border justify-content-center">
                        <label for="exampleFormControlInput1" class="form-label">目標圖片</label>
                        <div><input id="targetImgUploader" type="file" accept="image/*"/></div>
                        <div style="width: 256px; height: 256px" class="border">
                            <img
                                id="targetImg"
                                src="https://t3.ftcdn.net/jpg/04/60/01/36/360_F_460013622_6xF8uN6ubMvLx0tAJECBHfKPoNOR5cRa.jpg"
                                style="width: 100%; height: 100%;"
                                alt="Cinque Terre"
                            />
                        </div>
                    </div>
                </div>
                <div class="col-sm-1 border text-center d-flex flex-column justify-content-center">
                    <button
                        id="produceButton"
                        type="button"
                        class="btn align-items-center btn-outline-primary"
                    >
                        換臉》
                    </button>
                    <button
                        id="resetButton4"
                        type="button"
                        class="btn align-items-center btn-outline-primary"
                    >
                        《重置
                    </button>
                </div>
                <div class="col-sm border text-center">
                    <div class="border text-center d-flex flex-column justify-content-center align-items-center">
                        <label for="exampleFormControlInput1" class="form-label">產生的圖片</label>
                        <div style="width: 512px; height: 512px" class="border">
                            <img
                                id="producedImg2"
                                src="https://t3.ftcdn.net/jpg/04/60/01/36/360_F_460013622_6xF8uN6ubMvLx0tAJECBHfKPoNOR5cRa.jpg"
                                style="width: 100%; height: 100%;"
                                alt="Cinque Terre"
                            />
                        </div>
                    </div>
                </div>
            </div>            

            <div class="row border">
                <label
                    for="exampleFormControlInput1"
                    class="form-label"
                >
                    <h3 class="text-primary">NPC</h3>
                </label>
                <div class="col-sm border text-center">
                    <div class="row border">
                        <label for="exampleFormControlInput1" class="form-label">提問區</label>
                        <!-- 可修改 rows 增加輸入框高度 -->
                        <textarea
                            class="form-control"
                            id="exampleFormControlTextarea6"
                            rows="5" 
                            placeholder="請輸入對話"
                        ></textarea>
                    </div>
                    <div class="row border mt-3">
                        <label for="customRange3" class="form-label">最大回應字數</label>
                        <input
                            type="range"
                            class="form-range"
                            min="0"
                            max="5000"
                            step="1"
                            id="customRange3"
                            onchange="changeMaxTokens(this.value)"
                        >
                        <span id="tokenspan"></span>
                    </div>
                    <div class="row border mt-3">
                        <label for="customRange3" class="form-label">隨機度</label>
                        <input
                            type="range"
                            class="form-range"
                            min="0"
                            max="2"
                            step="0.1"
                            id="customRange4"
                            onchange="changeTemperature(this.value)"
                        >
                        <span id="temperaturespan"></span>                        
                    </div>
                </div>
                <div class="col-sm-1 border text-center d-flex flex-column justify-content-center">
                    <button
                        id="queryButton"
                        type="button"
                        class="btn align-items-center btn-outline-primary"
                    >
                        對話》
                    </button>
                    <button
                        id="resetButton3"
                        type="button"
                        class="btn align-items-center btn-outline-primary"
                    >
                        《重置
                    </button>                    
                </div>
                <div class="col-sm border text-center">
                    <label for="exampleFormControlInput1" class="form-label">NPC 回應</label>
                    <!-- 可修改 rows 增加輸入框高度 -->
                    <textarea
                        class="form-control"
                        id="exampleFormControlTextarea7"
                        rows="10"
                        disabled="true"
                    ></textarea>                    
                </div>
            </div>

        </div>

        <!-- Latest compiled JavaScript -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // DOM
            const textAreaSystem = document.getElementById("exampleFormControlTextarea1");
            const textAreaUser = document.getElementById("exampleFormControlTextarea2");
            const textAreaOutput = document.getElementById("exampleFormControlTextarea3");
            const textAreaPositivePrompts = document.getElementById("exampleFormControlTextarea4");
            const textAreaNegativePrompts = document.getElementById("exampleFormControlTextarea5");
            const textAreaQuery = document.getElementById("exampleFormControlTextarea6");
            const textAreaResponse = document.getElementById("exampleFormControlTextarea7");
            const resetButton = document.getElementById("resetButton");
            const promptButton = document.getElementById("promptButton");
            const imageButton = document.getElementById("imageButton");
            const resetButton2 = document.getElementById("resetButton2");
            const producedIm2g = document.getElementById("producedIm2g");
            const queryButton = document.getElementById("queryButton");
            const resetButton3 = document.getElementById("resetButton3");
            const maxTokenRange = document.getElementById("customRange3");
            const tokenspan = document.getElementById("tokenspan");
            const temperatureRange = document.getElementById("customRange4");
            const temperaturespan = document.getElementById("temperaturespan");
            const sourceImgUploader = document.getElementById("sourceImgUploader");
            const sourceImg = document.getElementById("sourceImg");
            const targetImgUploader = document.getElementById("targetImgUploader");
            const targetImg = document.getElementById("targetImg");
            const resetButton4 = document.getElementById("resetButton4");
            const producedImg2 = document.getElementById("producedImg2");
            const produceButton = document.getElementById("produceButton");
            // constant
            const sysText = "你熟悉prompts architecture的產生，我會給你一段描述，你幫我生成一段可以用來生成有正面人像照片寫實風格的prompt，結果請用英文回應。如果描述沒有人像，生成一段亞洲漂亮女生的prompt";
            const userText = "狗狗";
            const promptOpUrl = "https://asia-east1-mymoji-dev.cloudfunctions.net/mymoji-prompt-optimize";
            const produceImageUrl = "https://mymoji-face-gen-rnbnp7zqba-de.a.run.app";
            const npcUrl = "https://asia-east1-mymoji-dev.cloudfunctions.net/function-npc-test";
            const faceChangeUrl = "https://asia-east1-mymoji-dev.cloudfunctions.net/mymoji-face-change";
            const maxTokensDefault = 1024;
            const temperatureDefault = 0.2;
            const imageDefault = "https://t3.ftcdn.net/jpg/04/60/01/36/360_F_460013622_6xF8uN6ubMvLx0tAJECBHfKPoNOR5cRa.jpg";

            const items = {
                item1: {
                    loading: false,
                    button: promptButton,
                    text: "優化》"
                },
                item2: {
                    loading: false,
                    button: imageButton,
                    text: "產圖片"
                },
                item3: {
                    loading: false,
                    button: queryButton,
                    text: "對話》"
                },
                item4: {
                    loading: false,
                    button: produceButton,
                    text: "換臉》"
                },
            }

            const init = () => {
                console.log("init");
                resetPrompt();
                resetPrompt2();
                resetPrompt3();
            };

            const resetPrompt = () => {
                textAreaSystem.value = sysText;
                textAreaUser.value = userText;
            };

            const resetPrompt2 = () => {
                textAreaPositivePrompts.value = "";
                textAreaNegativePrompts.value = "";
            };

            const resetPrompt3 = () => {
                textAreaQuery.value = "";
                textAreaResponse.value = "";
                maxTokenRange.value = maxTokensDefault;
                tokenspan.textContent = maxTokensDefault;
                temperatureRange.value = temperatureDefault;
                temperaturespan.textContent = temperatureDefault;
            }

            const resetImage = () => {
                sourceImg.src = imageDefault;
                targetImg.src = imageDefault;
                producedImg2.src = imageDefault;
            }

            const setPromptButtonText = (item) => {
                if(items[item].loading) {
                    items[item].button.textContent = "waiting...";
                    items[item].button.disabled = true;
                } else {
                    items[item].button.textContent = items[item].text;
                    items[item].button.disabled = false;
                }
            };

            const changeMaxTokens = (value) => {
                tokenspan.textContent = value;
            };

            const changeTemperature = (value) => {
                temperaturespan.textContent = value;
            }


            resetButton.addEventListener("click", () => {
                console.log("resetItem1");
                resetPrompt();
            });

            resetButton2.addEventListener("click", () => {
                console.log("resetItem2");
                resetPrompt2();
            });

            resetButton3.addEventListener("click", () => {
                console.log("resetItem3");
                resetPrompt3();
            }); 
            
            resetButton4.addEventListener("click", () => {
                console.log("resetItem4");
                resetImage();
            }); 

            promptButton.addEventListener("click", () => {
                const currentItem = "item1";
                items[currentItem].loading = true;
                setPromptButtonText(currentItem);

                const raw = JSON.stringify({
                    "system_content": textAreaSystem.value,
                    "user_content": textAreaUser.value
                });

                const requestOptions = {
                    method: "POST",
                    body: raw,
                    headers: {
                        "user-agent": "Mozilla/4.0 MDN Example",
                        "content-type": "application/json",
                    }
                };

                fetch(promptOpUrl, requestOptions).then((response) => response.json())
                                                  .then((result) => {
                                                    console.log(result.generated_prompt);
                                                    textAreaOutput.value = result.generated_prompt;
                                                  })
                                                  .catch((error) => {
                                                    console.error(error);
                                                    textAreaOutput.value = error;
                                                  })
                                                  .finally(() => {
                                                    items[currentItem].loading = false;
                                                    setPromptButtonText(currentItem);
                                                  });

            });
            
            imageButton.addEventListener("click", async () => {
                const currentItem = "item2";
                items[currentItem].loading = true;
                setPromptButtonText(currentItem);

                const raw = JSON.stringify({
                    "prompt": textAreaPositivePrompts.value,
                    "negative_prompt": textAreaNegativePrompts.value
                });

                const requestOptions = {
                    method: "POST",
                    body: raw,
                    headers: {
                        "user-agent": "Mozilla/4.0 MDN Example",
                        "content-type": "application/json",
                    },
                    signal: AbortSignal.timeout(60000000000)
                };

                try{
                    const response = await fetch(produceImageUrl, requestOptions);
                    const imageBlob = await response.blob();
                    const imageUrl = URL.createObjectURL(imageBlob);
                    producedImg.src = imageUrl;
                } catch(error) {
                    console.log(error);
                    alert("Timeout");
                } finally {
                    items[currentItem].loading = false;
                    setPromptButtonText(currentItem);
                }
            });

            queryButton.addEventListener("click", async () => {
                const currentItem = "item3";
                items[currentItem].loading = true;
                setPromptButtonText(currentItem);

                const raw = JSON.stringify({
                    "query": textAreaQuery.value,
                    "max_tokens": maxTokenRange.value,
                    "temperature": temperatureRange.value
                });

                const requestOptions = {
                    method: "POST",
                    body: raw,
                    headers: {
                        "user-agent": "Mozilla/4.0 MDN Example",
                        "content-type": "application/json",
                    },
                };

                try{
                    const response = await fetch(npcUrl, requestOptions);
                    const resp = await response.json();
                    textAreaResponse.value = resp.msg;
                } catch(error) {
                    console.log(error);
                } finally {
                    items[currentItem].loading = false;
                    setPromptButtonText(currentItem);
                }                
            })

            produceButton.addEventListener("click", async () => {
                console.log("換臉產圖")
                const currentItem = "item4";
                items[currentItem].loading = true;
                setPromptButtonText(currentItem);

                if (sourceImg.src == imageDefault) {
                    alert("請選擇來源圖片");
                    items[currentItem].loading = false;
                    setPromptButtonText(currentItem);
                    return false;
                };

                if (targetImg.src == imageDefault) {
                    alert("請選擇目標圖片");
                    items[currentItem].loading = false;
                    setPromptButtonText(currentItem);                    
                    return false;
                }
                
                const source = await fetch(sourceImg.src);
                const sourceBlob = await source.blob();
                const target = await fetch(targetImg.src);
                const targetBlob = await target.blob();

                const raw = new FormData();
                raw.append("source_image", sourceBlob);
                raw.append("target_image", targetBlob);

                // const raw = {
                //     "source_image": sourceBlob,
                //     "target_image": targetBlob
                // }

                const requestOptions = {
                    method: "POST",
                    body: raw,
                    headers: {
                        "user-agent": "Mozilla/4.0 MDN Example",
                        // "content-type": "multipart/form-data",
                    },
                };
                
                try{
                    const response = await fetch(faceChangeUrl, requestOptions);
                    const imageBlob = await response.blob();
                    const imageUrl = URL.createObjectURL(imageBlob);
                    producedImg2.src = imageUrl;
                } catch(error) {
                    console.log(error);
                } finally {
                    items[currentItem].loading = false;
                    setPromptButtonText(currentItem);
                }                                
            })

            sourceImgUploader.addEventListener("change", (e) => {
                const imageBlob = e.target.files[0];
                const imageUrl = URL.createObjectURL(imageBlob);
                sourceImg.src = imageUrl;
            })

            targetImgUploader.addEventListener("change", (e)=> {
                const imageBlob = e.target.files[0];
                const imageUrl = URL.createObjectURL(imageBlob);
                targetImg.src = imageUrl;
            })

            init();
            
        </script>
        <!-- script type="module" 需以 localhost 開啟才不會發生 CORS 異常-->

    </body>
</html>